{% extends 'admin/parking_lots.html' %}

{% block title %}
Vehicle-P | Search
{% endblock %}

{% block main_content %}
<div class="container-fluid py-4 px-3 px-md-5">

    <div class="row justify-content-center mb-4 sticky-top  py-3 shadow-sm z-3 custom-sticky-top">
        <div class="col-12 col-md-10 col-lg-8">
            <form method="POST" action="{{ url_for('admin.search') }}" class="mb-4 d-flex">
                {{ form.hidden_tag() }}
                {{ form.search_by.label(class="form-label me-2") }}
                {{ form.search_by(class_='form-select d-inline w-auto me-2') }}
                {{ form.search_value(class_='form-control d-inline w-50 me-2') }}
                {{ form.submit(class_='btn btn-warning me-2') }}
                <a href="{{ url_for('admin.clear_search') }}" class="btn btn-secondary text-center">Clear</a>
            </form>
        </div>
    </div>

    {% if lots or user or vehicle %}
    <div class="text-center mb-3">
        <h6 class="">Showing results for "<strong>{{ search_location }}</strong>"</h6>
    </div>
    {% endif %}
    {% if lots %}
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0"><i class="fas fa-map-marker-alt me-1"></i>Parking Lots</h1>
        </div>

        <div class="row g-4">
            {% for lot in lots %}
            <div class="col-sm-12 col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h2 class="card-title d-flex justify-content-between text-black">#{{lot.id}} {{
                            lot.prime_location_name }}<i class="fas fa-car"></i></h2>
                        <div class="mb-2">
                            <a href="{{ url_for('admin.edit_parking_lot', lot_id=lot.id) }}" class="btn btn-primary"
                                role="button">Edit</a>
                            <form method="POST" action="{{ url_for('admin.delete_parking_lot', lot_id=lot.id) }}"
                                class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ form.csrf_token.current_token }}">

                                <button type="submit" class="btn btn-danger"
                                    onclick="return confirm('Are you sure you want to delete this parking lot?')">Delete</button>
                            </form>
                        </div>
                        <p class="text-black small mb-3">
                            Occupied: {{ lot.occupied_spots }}/{{ lot.maximum_number_of_spots }}
                        </p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% for spot in lot.parking_spots | sort(attribute='spot_index') %}
                            <a href="{{ url_for('admin.view_delete_spot', spot_id=spot.id) }}">
                                <span
                                    class="badge {% if spot.status.value == 'O' %}bg-danger{% else %}bg-success{% endif %} p-3"
                                    data-bs-toggle="tooltip"
                                    title="{{ spot.spot_number }}">{{spot.status.value}}</span></a>
                            {% endfor %}
                        </div>
                        <div class="mt-auto">

                            <p class="text-truncate" title="{{ lot.address }}">
                                <i class="fa-solid fa-map me-2 text-secondary"></i>
                                <strong>Address:</strong> {{ lot.address }}
                            </p>
                            <p>
                                <i
                                    class="fa-solid fa-indian-rupee-sign me-2 text-success"></i><strong>Price/Hour:</strong>
                                {{ lot.price_per_hour }}
                            </p>
                            <p>
                                <i class="fa-solid fa-layer-group me-2 text-info"></i><strong>Floor Level:</strong> {{
                                lot.floor_level }}
                            </p>
                            <p>{{ lot.open_time.strftime("%I:%M %p") }} - {{ lot.close_time.strftime("%I:%M %p") }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% elif user %}
<div class="container mt-4">
    <h2 class="text-center mb-4">User Details</h2>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr class="text-success">
                    <th>ID</th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Address</th>
                    <th>Pincode</th>
                </tr>
            </thead>
            <tbody>

                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.address }}</td>
                    <td>{{ user.pin_code }}</td>
                </tr>

            </tbody>
        </table>
    </div>
</div>
{% elif vehicle %}
<div class="container my-5">
    <!-- Vehicle Number Heading -->
    <div class="text-center mb-4">
        <h2 class="display-5 fw-bold text-uppercase">
            {{ vehicle.vehicle_number }}
        </h2>
    </div>


    <div class="card shadow rounded p-4">
        <table class="table table-borderless">
            <tbody>
                <tr>
                    <th scope="row" class="text-end w-50 ">Owner Name:</th>
                    <td>{{ vehicle.user.full_name if vehicle.user else 'N/A' }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Phone Number:</th>
                    <td>{{ vehicle.user.phone_number if vehicle.user else 'N/A' }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Address:</th>
                    <td>{{ vehicle.user.address if vehicle.user else 'N/A' }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Vehicle Brand:</th>
                    <td>{{ vehicle.brand }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Vehicle Model:</th>
                    <td>{{ vehicle.model }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Fuel Type:</th>
                    <td>{{ vehicle.fuel_type }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Vehicle Color:</th>
                    <td>{{ vehicle.color }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Spot ID:</th>
                    <td>{{ vehicle.reservations[0].spot_id if vehicle.reservations else 'N/A' }}</td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Parking Time:</th>
                    <td>
                        {% if vehicle.reservations %}
                        {{ vehicle.reservations[0].parking_timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row" class="text-end ">Leaving Time:</th>
                    <td>
                        {% if vehicle.reservations %}
                        {{ vehicle.reservations[0].leaving_timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="text-center my-5">
    <h3 class="">No results found.</h3>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
{% endblock %}